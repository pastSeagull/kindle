<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kindle Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #000000;
            font-family: sans-serif;
            overflow: hidden;
            /* Prevent scrolling if everything fits */
        }

        .container {
            width: 100%;
            height: 100%;
            padding: 10px;
            display: block;
        }

        /* Using a simple vertical distribution strategy compatible with old browsers */
        .header {
            height: 15%;
            text-align: center;
            border-bottom: 3px solid #000;
            display: block;
        }

        #time {
            font-size: 80px;
            /* Much bigger */
            font-weight: bold;
            line-height: 1.2;
            margin-top: 5px;
        }

        .section {
            margin-top: 15px;
            border: 2px solid #000;
            padding: 10px;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            text-decoration: underline;
            margin-bottom: 10px;
        }

        /* Sensor Area */
        .sensor-container {
            font-size: 32px;
            /* Bigger text */
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }

        .sensor-val {
            display: inline-block;
            margin: 0 15px;
        }

        /* Weather Area */
        .weather-section {
            margin-top: 15px;
        }

        .weather-now {
            font-size: 30px;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
            text-align: center;
        }

        .weather-list {
            width: 100%;
            text-align: center;
        }

        .weather-item {
            display: inline-block;
            width: 23%;
            vertical-align: top;
            font-size: 20px;
        }

        .weather-time {
            font-weight: bold;
            font-size: 22px;
        }

        .weather-temp {
            font-size: 28px;
            font-weight: bold;
        }

        .weather-desc {
            font-size: 18px;
        }

        /* Buttons Area - Push to bottom */
        .footer {
            margin-top: 20px;
            text-align: center;
        }

        .btn {
            display: inline-block;
            width: 48%;
            /* Side by side */
            height: 80px;
            line-height: 80px;
            /* Vertically center text */
            font-size: 30px;
            font-weight: bold;
            border: 3px solid #000;
            cursor: pointer;
            margin: 0 1%;
            text-decoration: none;
        }

        .btn-on {
            background-color: #000;
            color: #fff;
        }

        .btn-off {
            background-color: #fff;
            color: #000;
        }

        /* Icon styles */
        .icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            display: inline-block;
        }

        .icon-batt {
            width: 30px;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- 1. Time -->
        <div class="header">
            <div id="time">--:--</div>
        </div>

        <!-- 2. Indoor Sensor -->
        <div class="section">
            <div class="section-title">Indoor</div>
            <div id="sensor-data" class="sensor-container">Waiting...</div>
        </div>

        <!-- 3. Weather -->
        <div class="section weather-section">
            <div class="section-title">Weather</div>
            <div id="weather-now" class="weather-now">
                Loading...
            </div>
            <div id="weather-list" class="weather-list">
                <!-- Hourly items -->
            </div>
        </div>

        <!-- 4. Controls -->
        <div class="footer">
            <div class="btn btn-on" onclick="toggleLight('on')">ON</div>
            <div class="btn btn-off" onclick="toggleLight('off')">OFF</div>
        </div>
    </div>

    <script>
        // Simple SVGs
        var SVG_DROPLET = '<svg class="icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C12 2 5 8 5 13a7 7 0 0 0 14 0c0-5-7-11-7-11z"/></svg>';
        var SVG_BATTERY = '<svg class="icon icon-batt" viewBox="0 0 24 24"><rect x="2" y="6" width="18" height="12" rx="2" stroke="currentColor" fill="none" stroke-width="2"/><rect x="22" y="10" width="2" height="4" fill="currentColor"/><rect x="4" y="8" width="10" height="8" fill="currentColor"/></svg>';

        function updateData() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    render(data);
                }
            };
            xhr.open("GET", "/api/data", true);
            xhr.send();
        }

        function render(data) {
            document.getElementById('time').innerText = data.time;

            // Sensor
            var sensorDiv = document.getElementById('sensor-data');
            if (data.sensor) {
                // Format: 25.5째C  |  [Drop] 50%  |  [Batt] 80%
                sensorDiv.innerHTML =
                    '<span class="sensor-val">' + data.sensor.temp + '째C</span>' +
                    '<span class="sensor-val">' + SVG_DROPLET + ' ' + data.sensor.humi + '%</span>' +
                    '<span class="sensor-val">' + SVG_BATTERY + ' ' + data.sensor.batt + '%</span>';
            } else {
                sensorDiv.innerText = "Scanning...";
            }

            // Weather Now
            var weaNowDiv = document.getElementById('weather-now');
            if (data.weather && data.weather.now) {
                weaNowDiv.innerHTML =
                    '<strong>' + data.weather.now.temp + '째C</strong> ' +
                    data.weather.now.text +
                    ' (' + SVG_DROPLET + ' ' + data.weather.now.humidity + '%)';
            }

            // Weather Hourly
            var weaListDiv = document.getElementById('weather-list');
            if (data.weather && data.weather.hourly && data.weather.hourly.length > 0) {
                var html = '';
                var count = 0;
                for (var i = 0; i < data.weather.hourly.length && count < 4; i++) {
                    var item = data.weather.hourly[i];
                    var timeStr = item.fxTime.split('T')[1].substring(0, 5);

                    html += '<div class="weather-item">';
                    html += '<div class="weather-time">' + timeStr + '</div>';
                    html += '<div class="weather-temp">' + item.temp + '째</div>';
                    html += '<div class="weather-desc">' + item.text + '</div>';
                    html += '</div>';
                    count++;
                }
                weaListDiv.innerHTML = html;
            }
        }

        function toggleLight(action) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/light", true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4) {
                    // Flash feedback?
                    if (xhr.status == 200) {
                        // alert("OK"); // Don't alert on Kindle, it blocks UI
                    }
                }
            };
            xhr.send(JSON.stringify({ "action": action }));
        }

        setInterval(updateData, 10000);
        updateData();
    </script>

</body>

</html>